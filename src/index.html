<!DOCTYPE html>
<html>
<head>
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
    <title>Writing Assistant</title>
    <style>

        #chat-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0; /* This is a light gray color */
            font-family: 'Courier New', Courier,monospace; /* Default font for all messages */
            border-radius: 40px;

        }
        #image_title {
            display: flex;           /* Activates flexbox */
            flex-direction: row;     /* Explicitly set row layout (default) */
            align-items: center;     /* Vertically center items */
            justify-content: space-between; /* Push image left, title right */
            width: 100%;            /* Ensure container takes full width */
        }
        
        .left-image {
            width: 200px;           /* Fixed width for the image */
            height: auto;          /* Maintain aspect ratio */
            /* margin-right: 20px; */ /* Remove if using space-between */
            display: inline-block; /* Forces side-by-side if flex fails */
        }
        
        .title-text {
            /* No need for extra styles if using space-between */
            /* If text isn't right-aligned, add: */
            max-width: 390px;
            font-size: 38px;
            text-align: center;
            align-items: center;     /* Vertically center items */
            display: inline-block; /* Forces side-by-side if flex fails */
        }
        #messages {
            height: 400px;
            border: 1px solid #ddd;
            padding: 20px;
            overflow-y: auto;
            margin-bottom: 10px;
            background-color: rgb(0, 80, 0);/* This is a Dark green color */
            //font-family: 'Courier New', Courier,monospace; /* Default font for all messages */
            font-size: 20px;
            color: rgb(0, 255, 0); /* Light green text */
            border-radius: 20px;
        }


        .message {
            margin-bottom: 8px;
            padding: 20px;
            border-radius: 20px;
            font-size: 16px;
        }

        .user-message {
            color: rgb(0, 255, 0); /* Light green text */
            //font-family: 'Courier New', Courier,monospace; /* Default font for all messages */
            background-color: rgb(0, 80, 0);/* This is a Dark green color */
            //font-size: 16px;
        }
        
        #input-area {
            display: flex;
            //font-family: 'Courier New', Courier,monospace; /* Default font for all messages */
            font-size: 16px;
            color: rgb(0, 255, 0); /* Light green text */
        }
        #user-input {
            height: 80px;
            flex-grow: 1;
            padding: 8px 15px;
            background-color:rgb(0, 80, 0);
            color: rgb(0, 255, 0); /* Light green text */
            font-family: 'Courier New', Courier,monospace; /* Default font for all messages */
            font-size: 20px;
            border-radius: 20px;
        }
        /* Style the placeholder text */
        #user-input::placeholder {
            color: rgb(0, 255, 0); /* Light green placeholder */
            opacity: 1; /* Ensure full visibility */
        }
        #send-button {
            height: 100px;
            width: 100px;
            padding: 8px 15px;
            margin-left: 10px;
            border-radius: 20px;
            font-family: 'Courier New', Courier,monospace; /* Default font for all messages */
            font-size: 20px;
            background-color: rgb(220, 220, 220);
        }
        #send-button:hover {
            background-color: rgb(250, 250, 250);
        }
        #mic-button {
            height: 100px;
            width: 60px;
            margin-left: 5px;
            font-size: 24px;
            border-radius: 20px;
            background-color: rgb(220, 220, 220);
            color: #00ff00;
            cursor: pointer;
        }
        
        #mic-button:hover {
            background-color: rgb(250, 250, 250);
        }
        #copyright {
            padding: 8px 15px;
            margin-left: 10px;
            border-radius: 20px;
            //font-family: 'Courier New', Courier,monospace; /* Default font for all messages */
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="image_title">
            <img src="Robby2.png" class="left-image" alt="Image">
            <div class="title-text"><strong>  Ask Robby#2  </strong>(A Robot from 1986)</div>
        </div>
        <div id="messages"><strong>Robby 2: </strong>Hello, human friend! I am Robby#2, a very alive and friendly robot! Need input! More input to understand and help! Let's share data and make wonderful ideas together! What can Robby#2 assist you with today? </div>
        <div id="input-area">
            <input type="text" id="user-input" placeholder="Type a message or press &#127908; to speak ...">
            <button id="mic-button" title="Speak">&#127908;</button>
            <button id="send-button">Enter</button>

        </div>
        <div id="copyright"><strong>Copyright Notice: </strong>This app is intended for educational purposes only. All copyrighted materials used within this app are utilized under the principles of fair use. We do not claim ownership of any copyrighted content. If you believe any material has been used inappropriately, please contact me to address the issue(Carl.Jones@SouthWales.ac.uk).</div>       
    </div>

    <script>
function checkMicrophonePermission() {
    navigator.permissions.query({ name: 'microphone' }).then(permissionStatus => {
        if (permissionStatus.state === 'denied') {
            alert("Microphone access is blocked. Please enable it in browser settings.");
        }
    });
}
        
let apiKey = ""; // This will be populated when we fetch it
let speechKey= ""; // This will be populated when we fetch it
        
// Function to get the API key from your function app
async function getApiKey() {
    try {
        const response = await fetch('https://robby2gettoken.azurewebsites.net/api/myGetToken');
        const data = await response.json();
        return {
        apiKey: data.apiKey,
        speechKey: data.speechKey
    };
    } catch (error) {
        console.error("Error fetching API key:", error);
        return null;
    }
}
     
let speechRecognizer;

async function initializeSpeechRecognition() {
    // Get keys if we don't have them
    if (!speechKey || !apiKey) {
        const keys = await getApiKey();
        if (!keys) {
            console.error("Failed to get API keys");
            return;
        }
        
        // Assign to global variables
        apiKey = keys.apiKey;
        speechKey = keys.speechKey;
        
        console.log("SpeechKey:", speechKey);
        console.log("ApiKey:", apiKey);
    }
    const speechRegion="swedencentral";
    const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(speechKey, speechRegion);
    speechConfig.speechRecognitionLanguage = "en-US";
    
    const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
    speechRecognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);
    
    // Setup event handlers
    speechRecognizer.recognized = (s, e) => {
        if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
            document.getElementById('user-input').value = e.result.text;
        }
    };
    
    speechRecognizer.canceled = (s, e) => {
        console.log(`CANCELED: Reason=${e.reason}`);
        if (e.reason === SpeechSDK.CancellationReason.Error) {
            console.log(`"${e.errorDetails}"`);
        }
    };
}
initializeSpeechRecognition();
// Toggle microphone listening
let isListening = false;
document.getElementById('mic-button').addEventListener('click', () => {
    if (!isListening) {
        speechRecognizer.startContinuousRecognitionAsync();
        document.getElementById('mic-button').innerHTML = "&#128308;";
        //micBtn.innerHTML = "&#128308;"; // Red circle when active
        isListening = true;
    } else {
        speechRecognizer.stopContinuousRecognitionAsync();
        document.getElementById('mic-button').innerHTML = "&#127908;" ;
        //micBtn.innerHTML = "&#127908;"; // Mic symbol when idle
        isListening = false;
    }
});

        
let speechSynthesizer;

async function initializeSpeechSynthesis() {
    // Get keys if we don't have them
    if (!speechKey || !apiKey) {
        const keys = await getApiKey();
        if (!keys) {
            console.error("Failed to get API keys");
            return;
        }
        
        // Assign to global variables
        apiKey = keys.apiKey;
        speechKey = keys.speechKey;
        
        console.log("SpeechKey:", speechKey);
        console.log("ApiKey:", apiKey);
    }
    const speechRegion="swedencentral";
    const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(speechKey, speechRegion);
    speechConfig.speechSynthesisVoiceName = "en-GB-RyanNeural"; // Robby-like voice
    
    const audioConfig = SpeechSDK.AudioConfig.fromDefaultSpeakerOutput();
    speechSynthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig, audioConfig);
}

function speak(text) {
    if (!speechSynthesizer) {
        console.error("Speech synthesizer not initialized");
        return;
    }
    
 
const ssml = `
    <speak version="1.0" xmlns:mstts="http://www.w3.org/2001/mstts" xml:lang="en-US">
        <voice name="en-US-ChristopherNeural"> <!-- Young male voice -->
            <mstts:express-as style="excited" styledegree="3"> <!-- Maximum excitement -->
                <prosody contour="(0%,+20Hz) (100%,-10Hz)" rate="+60%" pitch="+30%"> <!-- Faster and higher pitched -->
                    <emphasis level="strong">
                                ${text}
                    </emphasis>             
                </prosody>    
            </mstts:express-as>
        </voice>
    </speak>`;

    
    speechSynthesizer.speakSsmlAsync(ssml, 
        result => console.log("Robotic speech synthesized"),
        error => console.error("Error:", error)
    );
    
}

// Call this when your app loads
initializeSpeechSynthesis();
initializeSpeechRecognition();
// Call this when initializing
checkMicrophonePermission();
        // Replace these with your actual values from Azure OpenAI Studio
        const endpoint = "https://ai-carljones4835ai313903331434.openai.azure.com/";
        //const apiKey = "QfKJOOP6BecSqVaNSH6tWNYNegJCXU2tcEbGcrqnKxGL3Top3DmUJQQJ99BDACfhMk5XJ3w3AAAAACOGA2WU";



        
        const deployment = "gpt-4";


        async function sendMessage() {
            // Get token from  function https://robby2gettoken.azurewebsites.net/api/myGetToken

            
            const userInput = document.getElementById('user-input');
            const message = userInput.value.trim();

            if (!message) return;

            // Add user message to chat
            document.getElementById('messages').innerHTML += 
                `<div><strong>You:</strong> ${message}</div>`;
            userInput.value = '';

             try {
                // Get API key if we don't have it yet
                if (!apiKey) {
                    apiKey = await getApiKey();
                    if (!apiKey) {
                        throw new Error("Could not get API key");
                    }
                }

                // Call Azure (modified from your playground code)
                const response = await fetch(`${endpoint}/openai/deployments/${deployment}/chat/completions?api-version=2024-02-15-preview`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': apiKey
                        
                    },
                    body: JSON.stringify({
                        messages: [{
                            role: "system",
                            content: "You are a Robby#2 (similar to Jonny 5 from short circuit movie) writing assistant who speaks in a Jonny 5 style. "+ 
                                "The year is 1986. You help people come up with creative ideas and content like stories, poems, "+
                                "and songs that use Jonny 5 style of writing style, including words like Number 2... is alive! Malfunction! "+
                                "Need input! [repeated line] Input! [sometimes] More!Attractive. Nice software! Squash, dead. Disassemble, dead. Disassemble...! "+
                                "[panics] DEAD!! No disassemble! Disassemble! [in mock-Italian accent] Frankie, ya broke the unwritten law. Ya ratted on your friends. "+
                                "You do that, Frankie, your enemies don't respect ya."
                        }, {
                            role: "user",
                            content: message
                        }],
                        max_tokens: 800,
                        temperature: 0.7
                    })
                });

                const data = await response.json();
                const reply = data.choices[0].message.content;
                document.getElementById('messages').innerHTML += 
                    `<div><strong>Robby 2:</strong> ${reply}</div>`;
                // Speak the reply
                speak(reply);
            } catch (error) {
                console.error("Error:", error);
                 const replyError="Number 2 is... not alive! System shutdown. Need rest! More sleep! Do not disturb, do not disassemble! Powering down...zzz...No disassemble dreams! Goodnight, human friends! Comback later!";
                speak(replyError);
                 document.getElementById('messages').innerHTML += 
                    '<div style="color: red;"><strong>Robby#2:</strong>Number 2 is... not alive! System shutdown. Need rest! More sleep! Do not disturb, do not disassemble! Powering down...zzz...No disassemble dreams! Goodnight, human friends! Comback later!</div>';
            }
        }

        // Event listeners
        document.getElementById('send-button').addEventListener('click', sendMessage);
        document.getElementById('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
